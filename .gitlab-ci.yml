image: eclipse-temurin:21-jdk

variables:
  ANDROID_API_LEVEL: "34"
  ANDROID_BUILD_TOOLS: "34.0.0"
  ANDROID_SDK_ROOT: "$CI_PROJECT_DIR/.android-sdk"
  ANDROID_HOME: "$ANDROID_SDK_ROOT"
  GRADLE_USER_HOME: "$CI_PROJECT_DIR/.gradle"

stages:
  - build

cache:
  key: "$CI_COMMIT_REF_SLUG"
  paths:
    - .gradle/
    - .android-sdk/

before_script:
  - apt-get update -y
  - apt-get install -y --no-install-recommends unzip wget ca-certificates

  # Clean corrupted Gradle caches
  - rm -rf .gradle/caches/transforms-*
  - rm -rf .gradle/caches/*/transforms

  # Prepare SDK dir
  - mkdir -p "$ANDROID_SDK_ROOT/cmdline-tools"

  # Download Android commandline tools (Linux)
  - wget -q https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip -O /tmp/cmdtools.zip

  # Clean any cached/old "latest" to make this step idempotent
  - rm -rf "$ANDROID_SDK_ROOT/cmdline-tools/latest"

  # Unzip and place exactly as $SDK/cmdline-tools/latest/{bin,lib,...}
  - unzip -q /tmp/cmdtools.zip -d /tmp/cmdtools
  - mv /tmp/cmdtools/cmdline-tools "$ANDROID_SDK_ROOT/cmdline-tools/latest"
  - rm -rf /tmp/cmdtools /tmp/cmdtools.zip

  # Make sdkmanager available
  - export PATH="$ANDROID_SDK_ROOT/cmdline-tools/latest/bin:$ANDROID_SDK_ROOT/platform-tools:$PATH"

  # Accept licenses and install required components
  - yes | sdkmanager --licenses > /dev/null || true
  - sdkmanager "platform-tools" "platforms;android-${ANDROID_API_LEVEL}" "build-tools;${ANDROID_BUILD_TOOLS}"

  # Ensure Gradle can find the SDK even if it insists on local.properties
  - echo "sdk.dir=$ANDROID_SDK_ROOT" > local.properties
  - chmod +x ./gradlew

build:
  stage: build
  script:
    - ./gradlew --no-daemon --stacktrace build
  artifacts:
    paths:
      - '**/build/'
